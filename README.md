# 八路循迹智能小车

基于 STM32F103ZET6 的八路红外循迹智能小车，采用双环 PID 闭环控制（循迹 PD 外环 + 速度 PI 内环），实现高速稳定循线、弯道自适应减速、超声波避障等功能。Keil uVision5 工程，标准库开发。

---

## 目录

- [器件材料表](#器件材料表)
- [功能特性](#功能特性)
- [项目结构](#项目结构)
- [开发历程](#开发历程)

---

## 器件材料表

### 核心控制

| 器件 | 型号/规格 | 说明 |
|------|-----------|------|
| 主控芯片 | STM32F103ZET6 | Cortex-M3, 72MHz, 512KB Flash, 64KB RAM |
| 小车底盘 | 定制亚克力/铝合金 | 精心挑选孔位，适配各模块安装 |

### 传感器模块

| 器件 | 型号/规格 | 说明 |
|------|-----------|------|
| 循迹传感器 | 亚博智能八路红外 | GPIO 直读 (PF1-PF4, PF6-PF9)，响应 <1us |
| 超声波模块 | HSR04 | 前方避障测距，非阻塞轮询，60ms 采样周期 |

### 驱动与动力

| 器件 | 型号/规格 | 说明 |
|------|-----------|------|
| 电机 | G310 霍尔编码器电机 | 带 AB 相正交编码器，11PPR，1:20 减速比 |
| 橡胶轮 | 48mm | 配套 G310 电机 |
| 电机驱动 | TB6612FNG | 双路 H 桥驱动，支持 PWM 调速 |

### 显示与交互

| 器件 | 型号/规格 | 说明 |
|------|-----------|------|
| OLED 显示屏 | 0.96 寸四引脚 | I2C 接口，128x64 分辨率，分帧刷新 |
| 蜂鸣器 | 无源蜂鸣器 | 低电平触发，PWM 驱动，支持 8 种音效 |

### 电源管理

| 器件 | 型号/规格 | 说明 |
|------|-----------|------|
| 锂电池 | 辰克 2800mAh | 小型号端子，紧凑安装 |
| 降压模块 | MP1584 | 电池电压降至 5V 稳压输出 |

### 辅料与连接件

| 类别 | 明细 |
|------|------|
| 螺丝紧固 | M3 螺丝、铜柱、厚螺母；M2 螺丝、螺母 |
| 连接器 | 2.54mm 排针、排母 |
| 接线 | 杜邦线、面包板、面包板跳线 |
| 被动元件 | 10uF 直插电容、100nF 贴片陶瓷电容、4.7K 上拉电阻、1K 贴片电阻 |
| 指示器件 | 直插 LED（红/绿/指示） |

---

## 功能特性

### 1. 八路循迹：GPIO 高速识别

- 8 路红外传感器通过 GPIO 直接读取（PF1-PF4, PF6-PF9），读取耗时 <1us
- 非线性权重分布：`{-12, -8, -3, -1, 1, 3, 8, 12}`，边缘传感器权重更大，提升弯道灵敏度
- 加权求和计算循迹误差，支持丢线检测与方向推断
- 传感器值：0 = 检测到黑线，1 = 白色/无线

### 2. 双环 PID 闭环控制

- **外环（循迹 PD）**：根据循迹误差计算转向输出
  - 非线性 Kp 调度：误差越大比例增益越强（err=0: 1.0x → err=12+: 4.0x）
  - D 项抑制振荡，防止蛇形走位
  - 基础参数：Kp=12.0，Kd=2.5
- **内环（速度 PI）**：确保左右轮精确跟踪目标速度
  - 位置式 PI 控制，带积分限幅（±200）
  - 参数：Kp=0.15，Ki=0.08
- 控制周期 2ms（500Hz），高频保证响应及时

### 3. 弯道自适应减速

- 根据循迹误差自动调节基础速度：误差越大，速度越低
- 减速曲线：err=2 保持 97% → err=5 降至 77% → err=10 降至 45% → err=15+ 降至 12%
- 直线基础速度 650mm/s，弯道最低 60mm/s，上限 1100mm/s

### 4. 编码器测速与里程

- MG310 霍尔编码器，11PPR x 20 减速比 x 4 倍频 = 880 脉冲/转
- 左电机 TIM2（PA0/PA1），右电机 TIM3（PA6/PA7），硬件正交解码
- 实时输出：转速 RPM、线速度 mm/s、累计距离 mm
- 左轮方向反转补偿（ENCODER_L_INVERT=1）

### 5. 超声波避障（简易实现）

- HSR04 超声波模块，PA9(Trig) / PA10(Echo)
- 非阻塞轮询模式，60ms 周期自动测距

### 6. OLED 双页面显示

- 0.96 寸 OLED，软件 I2C 驱动（PB10/PB11）
- 分帧刷新策略：运行时 1000ms / 待机 800ms，避免 I2C 通信阻塞控制回路
- 双页面切换（短按 PC5）：
  - **循迹实时页**：循迹误差 + 平均速度、目标速度 L/R、PWM L/R、传感器状态条（避障时显示距离）
  - **参数页**：Kp/Kd 值、基础速度、运行计时、超声波距离
- 启动长按进度条动画，终点到达显示完赛时间

### 7. 按键控制与交互

- **PC5 按键**：短按切换 OLED 页面，长按启动/停止循迹（带进度条反馈）
- **PC4 按键**：运行中按下 = 紧急停止；待机时按下 = 循环 LED 亮度档位（4 档：48→30→15→3）
- 软件消抖处理，按键事件队列机制

### 8. LED PWM 亮度控制

- 3 路 LED：PB9（绿）、PE0（红）、PE1（指示）
- PWM 占空比控制亮度，4 档循环（48/30/15/3）
- 运行时 LED 熄灭降低干扰，终点到达触发灯效

### 9. 蜂鸣器多音效提示

- 无源蜂鸣器 PB8，TIM5_CH3 PWM 驱动，支持频率控制
- 8 种内置音效序列：
  - **开机音**：Do-Sol-高Do 欢迎音
  - **激活提示**：短响 1 声（Sol）
  - **1 分钟提醒**：短响 2 声（Mi-Mi）
  - **终点到达**：3 声升调（Do-Mi-Sol）
  - **成功提示**：上升音阶 Do-Mi-Sol-高Do
  - **错误提示**：下降音阶 Sol-Mi-Do
  - **警告提示**：急促四连响（La x4）
  - **按键音**：极短 30ms 响

### 10. 串口调试日志系统

- 运行时日志存储到 RAM（最多 1400 条 LogEntry，约 20 秒数据 @10ms 周期）
- 停车后通过 UART4（115200 波特率）导出 CSV 格式诊断日志
- 每条记录包含：序号、测试编号、时间戳、循迹误差、传感器原始值、左右轮 PWM/速度/目标速度、控制标志位、饱和信息、动态 Kp 倍率等 22 个字段
- 支持多次测试标记（testId），方便分段分析
- 可通过宏 `LOG_ENABLE` 开关日志功能

---

## 项目结构

### 1. 主控入口与调度：`User/main.c`

`main.c` 是当前 V7 版本唯一的运行主流程入口，负责：

- 系统初始化与启动音效
- 按键事件处理（PC5 启停/切页，PC4 急停/亮度档位）
- 2ms 高频控制环（循迹 PD 外环 + 速度 PI 内环）
- 超声波避障状态机
- OLED 双页面渲染
- 运行日志记录

关键时序（主循环内）：

- **控制环**：`2ms`（`if ((nowMs - lastControlMs) >= 2)`）
- **超声波触发**：`60ms`（`OBS_PERIOD_MS`）
- **外设更新**：运行 `100ms` / 待机 `20ms`
- **OLED 刷新**：运行 `1000ms` / 待机 `800ms` / 长按提示 `150ms`
- **运行态节流**：每圈 `Delay_ms(1)`

`main()` 主流程拆解：

1. **初始化阶段**：`SysTick/按键/红外/超声波/OLED/UART4/LED_PWM/蜂鸣器/电机编码器/PI参数` 依次初始化
2. **待机阶段**：允许切页与亮度档位调整，电机保持停止
3. **启动阶段**：PC5 长按进入运行，清零里程/计时/滤波/状态机并打日志分隔标记
4. **运行阶段**：
   - 读取传感器并计算误差（含丢线恢复、终点投票、方向记忆）
   - 计算动态 `Kp` 与动态基础速度
   - 外环 PD 生成转向量，内环 PI 生成左右 PWM
   - 电机输出 + OLED 刷新 + 日志采样
5. **停止阶段**：急停/终点触发后，停止电机并导出日志

### 2. 功能-文件映射（当前主流程）

| 模块 | 主要文件 | 关键实现 | 参数/依据 |
|------|----------|----------|-----------|
| 循迹采集 | `Hardware/bsp_ir_gpio.c/.h` | `IR_GPIO_Init`、`IR_GPIO_Read` | GPIOF 8路引脚映射（PF1-PF4, PF6-PF9） |
| 循迹控制 | `User/main.c` | 加权误差、丢线恢复、交叉抑制、动态 Kp、PD 转向 | `SENSOR_WEIGHTS_V5`、`TRACK_KP/KD` |
| 速度环 | `User/main.c` | `PI_Init`、`PI_Compute`、目标速度合成、PWM 输出 | `SPEED_KP/KI`、`INTEGRAL_MAX`、`PWM_MAX/MIN` |
| 电机驱动 | `Hardware/bsp_motor.c/.h` | `Motor_SetSpeedBoth`、方向与PWM映射 | TB6612 管脚与 20kHz PWM |
| 编码器测速 | `Hardware/bsp_encoder.c/.h` | `Encoder_Init`、`Encoder_Update`、`Encoder_GetSpeedMMS` | 11PPR × 20 × 4 倍频、轮径48mm |
| 超声波避障 | `Hardware/HCSR04.c/.h` + `User/main.c` | `HCSR04_Poll`、`HCSR04_StartMeasure`、状态机接管 | `OBS_WARN_CM/OBS_AVOID_CM/OBS_EXIT_CM` |
| OLED 显示 | `Hardware/OLED.c/.h` + `User/main.c` | `OLED_ShowString` 分帧刷新，双页面显示 | `DISPLAY_PAGES=2`，按状态切页 |
| 按键输入 | `Hardware/bsp_key.c/.h`、`bsp_key2.c/.h` | `Key_Scan`、`Key2_GetEvent` | C5短/长按与 C4 事件分离 |
| LED 指示 | `Hardware/bsp_led_pwm.c/.h` | `LED_PWM_Init`、`LED_SetBrightness`、`LED_StartFinishEffect` | 待机4档亮度、终点灯效 |
| 蜂鸣器 | `Hardware/bsp_buzzer.c/.h` | `Buzzer_PlayBeep`、`Buzzer_BeepTriple`、`Buzzer_Update` | 启动/激活/急停/终点提示 |
| 串口日志 | `User/main.c` + `Hardware/bsp_usart.c/.h` | `Log_Add`、`Log_Start/Stop`、`Log_Export`、`UART4_Send_String` | `LOG_ENABLE`、`LOG_PERIOD_MS`、`LOG_MAX_ENTRIES` |

### 2.1 重点文件补充说明（你关心的模块）

- `Hardware/bsp_led_pwm.c/.h`：当前 LED 主实现，负责三路亮度 PWM、亮度档位、终点灯效。
- `Hardware/app_ui.c/.h`：历史 UI 页面框架（含陀螺仪页等），当前 V7 主流程未调用，现行显示逻辑在 `User/main.c` 内直接渲染。
- `Hardware/app_motor.c/.h`：历史运动封装（`Motion_Car_Control`），当前 V7 主流程主要直接走 `bsp_motor + bsp_encoder + main.c 内 PI`。
- `Hardware/bsp_encoder.c/.h`：编码器采样与速度/里程计算，给主循环速度环提供反馈。
- `Hardware/bsp_ir_gpio.c/.h`：循迹输入底层，8 路 GPIO 快速读取。
- `Hardware/bsp_buzzer.c/.h`：蜂鸣器音效状态机，主循环按周期调用 `Buzzer_Update`。
- `Hardware/HCSR04.c/.h`：超声波非阻塞测距，主循环轮询并驱动避障状态切换。

### 3. 参数集中位置（调参入口）

当前版本参数集中在 `User/main.c` 顶部宏区，便于赛道调参：

- **速度环参数**：`SPEED_KP`、`SPEED_KI`、`INTEGRAL_MAX`
- **循迹参数**：`TRACK_KP`、`TRACK_KD`
- **速度边界**：`BASE_SPEED_MMS`、`MIN_SPEED_MMS`、`MAX_SPEED_MMS`
- **避障阈值**：`OBS_WARN_CM`、`OBS_AVOID_CM`、`OBS_EXIT_CM`
- **日志参数**：`LOG_ENABLE`、`LOG_PERIOD_MS`、`LOG_MAX_ENTRIES`

建议调参顺序：

1. 先调速度环（确保左右轮可稳定跟踪目标）
2. 再调循迹环（Kp 响应、Kd 抑振）
3. 最后调避障阈值和基础速度

### 4. 备用/历史模块说明（当前主流程未调用）

以下文件在工程中仍可见，但**当前 V7 主流程未接入**：

- `Hardware/app_ui.c/.h`：旧版多页面 UI 框架（含陀螺仪页）
- `Hardware/app_control.c/.h`：旧版控制状态机框架（含陀螺仪输入接口）
- `Hardware/JY301P.c/.h`、`wit_c_sdk.c/.h`：陀螺仪协议与解析
---

## 开发历程

（待补充）
