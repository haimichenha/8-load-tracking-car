# 八路循迹智能小车

基于 STM32F103ZET6 的八路红外循迹智能小车，采用双环 PID 闭环控制（循迹 PD 外环 + 速度 PI 内环），实现高速稳定循线、弯道自适应减速、超声波避障等功能。Keil uVision5 工程，标准库开发。

---

## 目录

- [器件材料表](#器件材料表)
- [功能特性](#功能特性)
- [项目结构](#项目结构)
- [开发历程](#开发历程)

---

## 器件材料表

### 核心控制

| 器件 | 型号/规格 | 说明 |
|------|-----------|------|
| 主控芯片 | STM32F103ZET6 | Cortex-M3, 72MHz, 512KB Flash, 64KB RAM |
| 小车底盘 | 定制亚克力/铝合金 | 精心挑选孔位，适配各模块安装 |

### 传感器模块

| 器件 | 型号/规格 | 说明 |
|------|-----------|------|
| 循迹传感器 | 亚博智能八路红外 | GPIO 直读 (PF1-PF4, PF6-PF9)，响应 <1us |
| 超声波模块 | HSR04 | 前方避障测距，非阻塞轮询，60ms 采样周期 |
| 陀螺仪 | JY301P | I2C 通信，提供角速度 + 欧拉角 (Roll/Pitch/Yaw) |

### 驱动与动力

| 器件 | 型号/规格 | 说明 |
|------|-----------|------|
| 电机 | G310 霍尔编码器电机 | 带 AB 相正交编码器，11PPR，1:20 减速比 |
| 橡胶轮 | 48mm | 配套 G310 电机 |
| 电机驱动 | TB6612FNG | 双路 H 桥驱动，支持 PWM 调速 |

### 显示与交互

| 器件 | 型号/规格 | 说明 |
|------|-----------|------|
| OLED 显示屏 | 0.96 寸四引脚 | I2C 接口，128x64 分辨率，分帧刷新 |
| 蜂鸣器 | 无源蜂鸣器 | 低电平触发，PWM 驱动，支持 8 种音效 |

### 电源管理

| 器件 | 型号/规格 | 说明 |
|------|-----------|------|
| 锂电池 | 辰克 2800mAh | 小型号端子，紧凑安装 |
| 降压模块 | MP1584 | 电池电压降至 5V 稳压输出 |

### 辅料与连接件

| 类别 | 明细 |
|------|------|
| 螺丝紧固 | M3 螺丝、铜柱、厚螺母；M2 螺丝、螺母 |
| 连接器 | 2.54mm 排针、排母 |
| 接线 | 杜邦线、面包板、面包板跳线 |
| 被动元件 | 10uF 直插电容、100nF 贴片陶瓷电容、4.7K 上拉电阻、1K 贴片电阻 |
| 指示器件 | 直插 LED（红/绿/指示） |

---

## 功能特性

### 1. 八路循迹：GPIO 高速识别

- 8 路红外传感器通过 GPIO 直接读取（PF1-PF4, PF6-PF9），读取耗时 <1us
- 非线性权重分布：`{-12, -8, -3, -1, 1, 3, 8, 12}`，边缘传感器权重更大，提升弯道灵敏度
- 加权求和计算循迹误差，支持丢线检测与方向推断
- 传感器值：0 = 检测到黑线，1 = 白色/无线

### 2. 双环 PID 闭环控制

- **外环（循迹 PD）**：根据循迹误差计算转向输出
  - 非线性 Kp 调度：误差越大比例增益越强（err=0: 1.0x → err=12+: 4.0x）
  - D 项抑制振荡，防止蛇形走位
  - 基础参数：Kp=12.0，Kd=2.5
- **内环（速度 PI）**：确保左右轮精确跟踪目标速度
  - 位置式 PI 控制，带积分限幅（±200）
  - 参数：Kp=0.15，Ki=0.08
- 控制周期 2ms（500Hz），高频保证响应及时

### 3. 弯道自适应减速

- 根据循迹误差自动调节基础速度：误差越大，速度越低
- 减速曲线：err=2 保持 97% → err=5 降至 77% → err=10 降至 45% → err=15+ 降至 12%
- 直线基础速度 650mm/s，弯道最低 60mm/s，上限 1100mm/s

### 4. 编码器测速与里程

- MG310 霍尔编码器，11PPR x 20 减速比 x 4 倍频 = 880 脉冲/转
- 左电机 TIM2（PA0/PA1），右电机 TIM3（PA6/PA7），硬件正交解码
- 实时输出：转速 RPM、线速度 mm/s、累计距离 mm
- 左轮方向反转补偿（ENCODER_L_INVERT=1）

### 5. 超声波避障（简易实现）

- HSR04 超声波模块，PA9(Trig) / PA10(Echo)
- 非阻塞轮询模式，60ms 周期自动测距
- 检测到障碍物时触发避障状态机（代码已实现基本框架，未做深度调参测试）

### 6. OLED 多页面显示系统

- 0.96 寸 OLED，软件 I2C 驱动（PB10/PB11）
- 分帧刷新策略：运行时 1000ms / 待机 800ms，避免 I2C 通信阻塞控制回路
- 多页面切换（短按 PC5）：
  - **电机测试页**：PWM、实际速度、目标速度、PID 误差
  - **综合页**：三轴角度 + 二进制循迹 + 运行时间 + 速度
  - **循迹页**：传感器二进制值 + 偏移量 + 状态标注
  - **陀螺仪页**：三轴角度 + 最大速度

### 7. 按键控制与交互

- **PC5 按键**：短按切换 OLED 页面，长按启动/停止循迹
- **PC4 按键**：短按 PWM 调节 LED 亮度（5 档循环：0→10→20→35→50），长按切换亮度模式，双击紧急停止
- 软件消抖处理，按键事件队列机制

### 8. LED PWM 亮度控制

- 3 路 LED：PB9（绿）、PE0（红）、PE1（指示）
- PWM 占空比控制亮度，范围 0~50，支持灯效模式
- 按键联动调节亮度档位

### 9. 蜂鸣器多音效提示

- 无源蜂鸣器 PB8，TIM5_CH3 PWM 驱动，支持频率控制
- 8 种内置音效序列：
  - **开机音**：Do-Sol-高Do 欢迎音
  - **激活提示**：短响 1 声（Sol）
  - **1 分钟提醒**：短响 2 声（Mi-Mi）
  - **终点到达**：3 声升调（Do-Mi-Sol）
  - **成功提示**：上升音阶 Do-Mi-Sol-高Do
  - **错误提示**：下降音阶 Sol-Mi-Do
  - **警告提示**：急促四连响（La x4）
  - **按键音**：极短 30ms 响

### 10. 陀螺仪姿态感知

- JY301P 六轴陀螺仪，IO 模拟 I2C 通信
- 读取三轴角速度 + 欧拉角（Roll/Pitch/Yaw）
- 用于辅助弯道判断和姿态补偿

### 11. 串口调试日志系统

- 运行时日志存储到 RAM（最多 1400 条 LogEntry，约 20 秒数据 @10ms 周期）
- 停车后通过 UART4（115200 波特率）导出 CSV 格式诊断日志
- 每条记录包含：序号、测试编号、时间戳、循迹误差、传感器原始值、左右轮 PWM/速度/目标速度、控制标志位、饱和信息、动态 Kp 倍率等 22 个字段
- 支持多次测试标记（testId），方便分段分析
- 可通过宏 `LOG_ENABLE` 开关日志功能

### 12. 多模式编译支持

通过 `MOTOR_TEST_MODE` 宏切换不同运行模式：

| 模式 | 值 | 说明 |
|------|-----|------|
| 开环速度测试 | 1 | 测试不同 PWM 下的电机实际转速 |
| 闭环速度环验证 | 2 | 验证速度 PI 跟踪性能 |
| I2C 循迹 + 位置式 PI | 3 | V4 双环稳定版（10ms 周期） |
| **GPIO 循迹 + 高频闭环** | **4** | **V7 竞速推荐版（2ms 周期）** |
| 完整竞赛模式 | 0 | 集成陀螺仪 + 避障 + UI 全功能 |
