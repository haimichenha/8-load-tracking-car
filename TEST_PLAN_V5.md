# V5 (GPIO循迹 + 双环闭环) 漏洞反思与测试计划

> 目标：把"能跑"变成"可解释、可复现、可调参、可验收"。
>
> 范围：当前测试模式4（V5）控制链路：GPIO循迹(PF1-4/PF6-9) -> 外环循迹PD -> 目标左右轮速度 -> 内环速度PI -> PWM(含斜率限制/偏置/同步trim) -> 电机。

## 0. 基础原则（先防灾，再优化）

- 所有测试只改一个变量（参数/机械/电源/地面/轮胎）
- 每次改参数必须记录：日期、固件版本、参数、现象、结论
- 每次测试必须有"验收标准"，否则等同于没测
- 遇到冲刺/抖动先关D、降控制带宽、加滤波，再谈PD调参

## 1. 关键风险点清单（漏洞反思）

### 1.1 传感器层（循迹GPIO）

风险：
- 黑白线逻辑反了（raw位含义/上拉导致默认全1）
- GPIOF被SystemInit复用（外扩SRAM宏DATA_IN_ExtSRAM）
- 某一路悬空/短路导致误差长期偏置

对策：
- 上电静止时，OLED显示IR原始值应稳定（不应跳变）
- 手动遮挡每一路，IR位必须可控变化（单变量验证）
- 确认Start/system_stm32f10x.c中DATA_IN_ExtSRAM未启用（或确保PF未被改写）

验收：
- 8路依次遮挡，OLED上IR位变化与物理一致
- 不遮挡时IR稳定，抖动<= 1bit/秒（经验值）

### 1.2 速度测量层（编码器）

风险：
- 2ms采样导致量化噪声：计数很小->速度计算跳变->PI输出冲刺
- 编码器方向错误（左轮已反转，右轮可能也需反转）
- 某一路接触不良导致速度偶发为0

对策：
- 使用速度低通（SPEED_FILT_ALPHA）作为PI输入
- OLED显示滤波后速度，观察是否仍大幅跳变

验收：
- 空载匀速时，速度曲线肉眼稳定；不会出现周期性"0/高值"跳

### 1.3 控制层（双环耦合/积分风up/死区）

风险：
- 外环PD的D项放大噪声（尤其当采样抖动时）
- 速度PI在丢线/停车时积分累积（恢复时冲刺）
- PWM落入电机死区导致"右轮不动"或偏航

对策：
- 循迹误差低通（TRACK_ERR_ALPHA）后再算D
- 丢线>=300ms停止时，重置PI和滤波状态
- 保留PWM_MIN并在直行时使用sync-trim慢慢补偿机械差异

验收：
- 从停止->启动不出现明显冲刺（<0.5m内不突然加速）
- 丢线->停车->重新上线后不出现"猛冲"，能平滑恢复

### 1.4 执行层（电机/机械）

风险：
- 右轮齿轮松/摩擦差导致直行必偏
- 电源电压下降导致死区扩大

对策：
- 先机械修复（齿轮紧固、轮胎同心）再调参
- 使用sync-trim自动微调，避免靠常数PWM_OFFSET硬顶

验收：
- 在直线黑线段，误差接近0时，小车1m内偏移<= 5cm（可根据赛道调整）

## 2. 分阶段测试（从低风险到全速）

### 阶段A：不转轮的输入正确性测试

步骤：
1. 上电不启动（RUN=0）
2. 手动遮挡/放开每个探头

观察：
- OLED IR码是否与遮挡一致
- error符号是否符合"向哪边偏就往哪边修"的方向约定

通过条件：
- 8路一致且稳定

### 阶段B：单轮开环验证（排除硬件故障）

步骤：
1. 断开循迹逻辑影响（可临时固定targetL=targetR）
2. 仅设置固定PWM（例如15%）
3. 分别只转左轮/只转右轮

观察：
- 两轮都能启动且转向正确
- 编码器速度有响应且不掉0

通过条件：
- 两轮在同PWM下速度大致同量级（允许机械差10~30%）

### 阶段C：双轮速度闭环（不循迹）

目的：只验证"速度PI"本身是否稳定。

步骤：
1. 固定targetL=targetR=BASE_SPEED_MMS
2. 禁用外环（turnSpeed=0）
3. 在平地跑直线

观察：
- s_speedL_f_v5/s_speedR_f_v5是否稳定
- s_syncTrim_v5是否缓慢收敛（绝对值不应长期顶到上限）

通过条件：
- 速度不冲刺；trim收敛到某个小值（例如|trim|<3）

### 阶段D：低速循迹

步骤：
- BASE_SPEED_MMS从120开始
- TRACK_KD先设0（只用P）

观察：
- 是否还会"打转"或"突然冲"
- 误差在过线时是否平滑

通过条件：
- 能连续走线>=3圈不中断

### 阶段E：逐步加速与加D

步骤：
1. BASE_SPEED_MMS：120 -> 160 -> 200
2. 每次只改一个参数
3. 最后再逐步加TRACK_KD

观察：
- 速度提高后是否出现摆振
- D项引入后是否放大噪声（若是，减小TRACK_ERR_ALPHA或TRACK_KD）

通过条件：
- 目标速度下不丢线，过弯不明显外抛

## 3. 参数调参策略（建议顺序）

1. SPEED_KP/SPEED_KI：先让速度闭环不冲、不慢抖
2. PWM_MIN：确保两轮都能启动（尤其右轮）
3. TRACK_KP：让循迹能回线但不摆
4. TRACK_KD：只在噪声可控（滤波OK）后加入，用来压过冲
5. SYNC_TRIM_KI：只用于直行补偿，避免影响转弯

## 4. 必备记录项（每次测试都写）

- 电池电压（空载/加载）
- 地面材质、黑线宽度、光照
- BASE_SPEED_MMS / TRACK_KP / TRACK_KD / SPEED_KP / SPEED_KI
- PWM_MIN / PWM_MAX / PWM_SLEW_RATE / SPEED_FILT_ALPHA / TRACK_ERR_ALPHA
- 现象：直行偏航方向、是否冲刺、是否丢线、丢线恢复表现

## 5. 结论模板（写完这三句话就不算白测）

- 现象：________
- 推断原因：________
- 下一步只改一个变量：________
